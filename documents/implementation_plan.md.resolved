# Architecture Refinement: Metadata-Driven AI Agent

Transition the Agent's database interaction from "Direct Exploration" to "Metadata-Driven" to improve speed, safety, and intelligence.

## Current vs. Proposed Structure

### ❌ Current: Agent ↔ DB Direct
Agent tools ([profile_table_tool](file:///c:/Users/%EC%95%88%EC%A3%BC%ED%98%84/Desktop/AETL_program_dev/aetl_agent.py#112-124), [compare_row_counts](file:///c:/Users/%EC%95%88%EC%A3%BC%ED%98%84/Desktop/AETL_program_dev/aetl_agent.py#208-256)) connect to the database in real-time. This causes:
- **High Latency**: Profiling large tables takes minutes.
- **Resource Load**: Repeated LLM calls trigger repeated heavy SQL on the DB.
- **Blindness**: The Agent only "knows" a table after it queries it.

### ✅ Proposed: DB → Metadata Engine → Agent
1.  **Metadata Engine**: A background or manual sync process that crawls the DB and profiles data once, saving it to `.aetl_metadata.json`.
2.  **Metadata Store**: A centralized JSON/SQLite repository containing:
    - Schema (Tables, Columns, PK/FK)
    - Data Profiles (Null ratios, Min/Max, Distinct counts)
3.  **Agent**: Refined tools that query the **Metadata Store** instead of the live DB.

## Proposed Changes

### [Component] Metadata Engine
Define a unified sync logic.

#### [NEW] [aetl_metadata_engine.py](file:///c:/Users/안주현/Desktop/AETL_program_dev/aetl_metadata_engine.py)
- Orchestrates [db_schema.py](file:///c:/Users/%EC%95%88%EC%A3%BC%ED%98%84/Desktop/AETL_program_dev/db_schema.py) and [aetl_profiler.py](file:///c:/Users/%EC%95%88%EC%A3%BC%ED%98%84/Desktop/AETL_program_dev/aetl_profiler.py).
- Saves a unified metadata JSON containing both schema and profiling results.

### [Component] Agent Tools
Update tools in [aetl_agent.py](file:///c:/Users/%EC%95%88%EC%A3%BC%ED%98%84/Desktop/AETL_program_dev/aetl_agent.py).

#### [MODIFY] [aetl_agent.py](file:///c:/Users/안주현/Desktop/AETL_program_dev/aetl_agent.py)
- **[get_table_schema](file:///c:/Users/%EC%95%88%EC%A3%BC%ED%98%84/Desktop/AETL_program_dev/aetl_agent.py#54-89)**: Update to read from the unified metadata store.
- **[profile_table_tool](file:///c:/Users/%EC%95%88%EC%A3%BC%ED%98%84/Desktop/AETL_program_dev/aetl_agent.py#112-124)**: Change to "Read Profile from Metadata". If data is missing, inform the user to "Sync Metadata".
- **[search_tables](file:///c:/Users/%EC%95%88%EC%A3%BC%ED%98%84/Desktop/AETL_program_dev/aetl_agent.py#91-110)**: Enhance to use profiling metadata (e.g., search tables with >1M rows).

## Verification Plan

### Automated Tests
- Script to compare Agent response time using live DB vs. Metadata Cache.
- Validate that the Agent can describe a table's data distribution without any active DB connection.

### Manual Verification
- Streamlit UI: Add a "Sync Metadata" button.
- Verify the Agent correctly utilizes pre-collected profiles.
